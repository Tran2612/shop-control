<div class="container-fluid mt-4">
    <div class="container-lg border p-4">

        <!-- Tiêu đề -->
        <h1 class="text-center mb-4">Báo Cáo Tổng Quan Bán Hàng</h1>

        <!-- Thống kê nhanh -->
        <div class="row text-center mb-4 justify-content-center">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5>Doanh thu hôm nay</h5>
                        
                        <p class="display-6"><%= todayRevenue.toLocaleString() %> VND</p>
                        <!-- <p class="display-6">10,000,000₫</p> -->
                        
                        


                    </div>
                </div>
            </div>
            <!-- <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5>Lợi nhuận tháng</h5>
                        <p class="display-6">150,000,000₫</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h5>Khách hàng mới</h5>
                        <p class="display-6">35</p>
                    </div>
                </div>
            </div> -->
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <% if (bestSellingProduct) { %>
                            <h5>Sản phẩm bán chạy</h5>
                            <div>
                                <p class="display-6"><strong></strong> <%= bestSellingProduct.name %></p>
                                <!-- <p><strong>Giá:</strong> <%= bestSellingProduct.price %> VND</p>
                                <p><strong>Số lượng bán được:</strong> <%= maxQuantity %></p> -->
                            </div>
                        <% } else { %>
                            <p>Không có sản phẩm bán chạy trong ngày hôm nay.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ -->
        <div class="row mb-4">
            <!-- Biểu đồ doanh thu -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Doanh thu theo tháng</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="monthlyRevenueChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Tỷ lệ danh mục sản phẩm -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Tỷ lệ danh mục sản phẩm</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách dữ liệu -->
        <div class="row">
            
            <!-- Đơn hàng mới -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        
                        <h5>Đơn hàng mới</h5>
                        
                        
                    </div>
                    
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Mã đơn</th>
                                    <th>Khách hàng</th>
                                    <th>Tổng</th>
                                    <th>Ngày tạo</th>
                                </tr>
                            </thead>
                            <!-- <tbody>
                                {{#each bills}}
                                <tr>
                                    <td>{{this.code}}</td>
                                    <td>{{this.customerId.name}}</td>
                                    <td>{{this.totalAmount}}</td>
                                    <td>{{moment this.createdAt 'YYYY-MM-DD'}}</td>
                                </tr>
                                {{/each}}
                            </tbody> -->
                        
                                
                                <tbody>
                                    <% if (newOrders && newOrders.length > 0) { %>
                                        <% newOrders.forEach(order => { %>
                                            <tr>
                                                <td><%= order.code %></td>
                                                <td>
                                                    <% if(order.customerId && order.customerId.name) { %>
                                                        <%= order.customerId.name %>
                                                            <% } else { %>
                                                                Khách hàng
                                                                <% } %>
                                            
                                                </td>
                                                <td><%= order.totalAmount.toLocaleString() %> VND</td>
                                                <td><%= order.createdAt.toLocaleString('vi-VN') %></td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <p>Không có đơn hàng mới nào.</p>
                                    <% } %>
                                </tbody>
                            
                        </table>
                    </div>
                </div>
            </div>
            <!-- Sản phẩm hết hàng -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5>Sản phẩm gần hết hàng</h5>
                        
                    </div>
                    <div class="card-body">
                        <ul class="list-group">
                            <ul>
                                <% lowStockProducts.forEach(product => { %>
                                    <li>
                                        <%= product.name %> - Tồn kho: <%= product.stock %>
                                    </li>
                                <% }) %>
                            </ul>
                            <!-- <li class="list-group-item">Điện thoại iPhone 14 - Còn 5</li>
                            <li class="list-group-item">Laptop Dell - Còn 2</li>
                            <li class="list-group-item">Máy giặt Toshiba - Còn 1</li> -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Kiểm tra dữ liệu JSON trực tiếp trong EJS
        try {
            const monthlyRevenue = JSON.parse('<%- JSON.stringify(monthlyRevenue || []) %>');
            const categoryLabels = JSON.parse('<%- JSON.stringify(categoryLabels || []) %>');
            const categoryData = JSON.parse('<%- JSON.stringify(categoryData || []) %>');

            // Biểu đồ doanh thu theo tháng
            const monthlyLabels = [
                'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 
                'Tháng 6', 'Tháng 7', 'Tháng 8', 'Tháng 9', 
                'Tháng 10', 'Tháng 11', 'Tháng 12'
            ];

            const ctxRevenue = document.getElementById('monthlyRevenueChart').getContext('2d');
            new Chart(ctxRevenue, {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: monthlyRevenue,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                    }],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true 
                        } 
                    },
                },
            });

            // Biểu đồ tỷ lệ danh mục sản phẩm
            const ctxCategory = document.getElementById('categoryPieChart').getContext('2d');
            new Chart(ctxCategory, {
                type: 'pie',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                    }],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                    },
                },
            });
        } catch (error) {
            console.error('Error rendering charts:', error);
        }
    });
</script>
